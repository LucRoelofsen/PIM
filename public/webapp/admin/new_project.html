<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <title>Home</title>

  <!-- Bootstrap core and custom CSS -->
  <link href="../css/bootstrap.css" rel="stylesheet">
  <link href="../css/rijkscrowd.css" rel="stylesheet">
  <link href="../css/feather-icons.css" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
</head>

<body class="dashboard">

  <nav class="navbar navbar-expand-md navbar-dark fixed-left bg-dark">
    <a class="navbar-brand" href="#">RijksCrowd Dashboard</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="dashboard.html">Home<i class="fe fe-home float-right"></i></a>
        </li>
        <li class="nav-item dropdown active">
          <a class="nav-link dropdown-toggle" href="#" id="nav_projects" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Projects<i class="fe fe-edit float-right"></i>
          </a>
          <div class="dropdown-menu" aria-labelledby="nav_projects">
            <a class="dropdown-item" href="#">Statistics</a>
            <a class="dropdown-item" href="#">Manage Projects</a>
            <a class="dropdown-item" href="new_project.html">New Project</a>
          </div>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="nav_users" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Users<i class="fe fe-users float-right"></i>
          </a>
          <div class="dropdown-menu" aria-labelledby="nav_users">
            <a class="dropdown-item" href="#">Statistics</a>
            <a class="dropdown-item" href="#">Manage Users</a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Settings<i class="fe fe-settings float-right"></i></a>
        </li>
      </ul>
      <span class="navbar-text">
        <button class="btn btn-secondary my-2 my-sm-0" type="submit">Log out</button>
      </span>
    </div>
  </nav>

  <main role="main">

    <div class="container">

      <!-- Top content row -->
      <div class="row entry">
        <div class="col-md-5">
          <h3>New project</h3>
        </div>
      </div>

      <!-- Middle row -->
      <div class="row">
        <div class="col-md-12">
          <form class="box" method="post" action="" enctype="multipart/form-data">
            <div id="drop-zone">
              <div class="drop-zone-caption">Drag & Drop Files Here</div>
              <span class="btn btn-rijks btn-file" style="position: relative">
                <span class="">Choose files</span>
                <input type="file"id="drop-zone-file" name="files[]" multiple>
              </span>
            </div>
          </form>
        </div>
      </div>

      <hr class="featurette-divider">

    </div> <!-- /container -->

  </main>

  <footer class="container">
    <p class="lead pb-5">RijksCrowd Â© 2019. All rights reserved.</p>
  </footer>

  <!-- Javascript -->
  <script type="text/javascript" src="../js/bootstrap.js"></script>
  <script type="text/javascript" src="../js/rijkscrowd.js"></script>

  <script>

  var obj = $("#drop-zone");
  obj.on('dragenter', function (e) {
    e.stopPropagation();
    e.preventDefault();
    $(this).css('border', '2px solid #0B85A1');
  });
  obj.on('dragover', function (e) {
    e.stopPropagation();
    e.preventDefault();
  });
  obj.on('drop', function (e) {

    $(this).css('border', '2px dotted #0B85A1');
    e.preventDefault();
    var files = e.originalEvent.dataTransfer.files;

    //We need to send dropped files to Server
    handleFileUpload(files, obj);
  });

  $(document).on('dragenter', function (e) {
    e.stopPropagation();
    e.preventDefault();
  });
  $(document).on('dragover', function (e) {
    e.stopPropagation();
    e.preventDefault();
    obj.css('border', '2px dotted #0B85A1');
  });
  $(document).on('drop', function (e) {
    e.stopPropagation();
    e.preventDefault();
  });

  // automatically submit the form on file select
  $('#drop-zone-file').on('change', function (e) {
    var files = $('#drop-zone-file')[0].files;
    handleFileUpload(files, obj);
  });

  function handleFileUpload(files, obj) {
    for (var i = 0; i < files.length; i++) {
      var fd = new FormData();
      fd.append('file', files[i]);

      console.log(files[i]);
      fireBaseImageUpload({
        'file': files[i],
        'path': 'path_to_where_you_to_store_the_file'
      }, function (data) {
        //console.log(data);
        if (!data.error) {
          if (data.progress) {
            // progress update to view here
          }
          if (data.downloadURL) {
            // update done
            // download URL here "data.downloadURL"
          }
        } else {
          console.log(data.error + ' Firebase image upload error');
        }
      });
    }
  };

  function fireBaseImageUpload(parameters, callBackData) {

    // expected parameters to start storage upload
    var file = parameters.file;
    var path = parameters.path;
    var name;

    //just some error check
    if (!file) { callBackData({error: 'file required to interact with Firebase storage'}); }
    if (!path) { callBackData({error: 'Node name required to interact with Firebase storage'}); }

    var metaData = {'contentType': file.type};
    var arr = file.name.split('.');
    var fileSize = formatBytes(file.size); // get clean file size (function below)
    var fileType = file.type;
    var n = file.name;

    // generate random string to identify each upload instance
    name = generateRandomString(12); //(location function below)

    //var fullPath = path + '/' + name + '.' + arr.slice(-1)[0];
    var fullPath = path + '/' + file.name;

    var uploadFile = storageRef.child(fullPath).put(file, metaData);

    // first instance identifier
    callBackData({id: name, fileSize: fileSize, fileType: fileType, fileName: n});

    uploadFile.on('state_changed', function (snapshot) {
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      progress = Math.floor(progress);
      callBackData({
        progress: progress,
        element: name,
        fileSize: fileSize,
        fileType: fileType,
        fileName: n});
      }, function (error) {
        callBackData({error: error});
      }, function () {
        var downloadURL = uploadFile.snapshot.downloadURL;
        callBackData({
          downloadURL: downloadURL,
          element: name,
          fileSize: fileSize,
          fileType: fileType,
          fileName: n});
        });
      }

      function generateRandomString(length) {
        var chars = "abcdefghijklmnopqrstuvwxyz";
        var pass = "";
        for (var x = 0; x < length; x++) {
          var i = Math.floor(Math.random() * chars.length);
          pass += chars.charAt(i);
        }
        return pass;
      }

      function formatBytes(bytes, decimals) {
        if (bytes == 0) return '0 Byte';
        var k = 1000;
        var dm = decimals + 1 || 3;
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
      }

    </script>


  </body>
  </html>
